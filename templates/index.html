<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Medical Report Translator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <nav class="navbar">
        <div class="container">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo" class="navbar-logo">
            <span class="navbar-title">Medical Report Translator</span>
        </div>
    </nav>

    <form method="POST" enctype="multipart/form-data">
        <div class="form-row">
            <div class="form-group">
                <label for="file-upload" class="custom-upload">
                    üì§ Choose File (.txt or .docx)
                </label>
                <input type="file" id="file-upload" name="file" accept=".txt,.docx,.pdf"
                    onchange="handleFileChange(event)">
                <div class="file-name-container">
                    {% if file_name %}
                    <label for="file-name-input">Selected File</label>


                    {% endif %}
                    <input type="text" id="file-name-input" class="input-label" name="file_name"
                        value="{{ file_name or 'No file selected' }}" readonly>
                </div>
            </div>

        </div>


        <div class="form-row">
            <div class="form-group">
                <label for="src_lang">Select Source Language</label>
                <select id="src_lang" name="src_lang" required>
                    {% for code, name in languages.items() %}
                    <option value="{{ code }}" {% if src_lang==code %}selected{% endif %}>{{ name }} ({{code}})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="dest_lang">Select Target Language</label>
                <select id="dest_lang" name="dest_lang" required>
                    {% for code, name in languages.items() %}
                    <option value="{{ code }}" {% if dest_lang==code %}selected{% endif %}>{{ name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>



        <div class="form-row">
            <div class="form-group">
                <label for="original_text">Original Text {% if detected_lang %}<small>(Detected: {{ detected_lang
                        }})</small>{% endif %}</label>
                <textarea id="original_text" name="original_text">{{ original }}</textarea>
            </div>

            <div class="form-group">
                <label for="translated_google">Google Translate</label>
                <textarea id="translated_google" readonly>{{ translated_google }}</textarea>
            </div>

            <div class="form-group">
                <label for="translated_marian">MarianMT Translate</label>
                <textarea id="translated_marian" readonly>{{ translated_marian }}</textarea>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <button type="submit" name="action" value="translate" onclick="showSpinner()">üîÅ Translate</button>
                <span class="spinner" id="loadingSpinner">‚è≥ Translating...</span>
            </div>
        </div>
    </form>

    <script>
        function showSpinner() {
            document.getElementById('loadingSpinner').classList.add('show');
        }
        function handleFileChange(event) {
            const fileInput = event.target;
            const fileNameInput = document.getElementById('file-name-input');

            if (fileInput.files.length > 0) {
                const name = fileInput.files[0].name;
                fileNameInput.value = name;
                fileInput.form.submit();  // auto-submit when file selected
            } else {
                fileNameInput.value = '';
            }
        }

        const availableModels = JSON.parse('{{ available_models | safe }}');
        const languageNames = JSON.parse('{{ language_names | safe }}');

        const srcSelect = document.getElementById('src_lang');
        const destSelect = document.getElementById('dest_lang');

        // Value returned from server to restore selection
        const previouslySelected = "{{ dest_lang or '' }}";

        function updateDestLangOptions() {
            const srcLang = srcSelect.value;
            const validTargets = availableModels[srcLang] || [];

            destSelect.innerHTML = "";

            validTargets.forEach(code => {
                const option = document.createElement("option");
                option.value = code;
                option.textContent = `${languageNames[code] || code} (${code})`;

                // Check if this should be selected
                if (code === previouslySelected) {
                    option.selected = true;
                }

                destSelect.appendChild(option);
            });

            if (validTargets.length === 0) {
                const opt = document.createElement("option");
                opt.textContent = "No supported target languages";
                opt.disabled = true;
                destSelect.appendChild(opt);
            }
        }

        srcSelect.addEventListener("change", updateDestLangOptions);
        window.addEventListener("DOMContentLoaded", updateDestLangOptions);


    </script>

    <footer class="footer">
        <p>&copy; {{ current_year }} m.bufano Universit√§ts Klinikum Freiburg. All rights reserved.</p>
    </footer>


</body>

</html>